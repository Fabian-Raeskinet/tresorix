@page "/platforms"
@using Front.Components
@using Tresorix.Contracts.Platforms
@using System.Web
@inject HttpClient Http

<PageTitle>Platforms</PageTitle>

<h1>Platforms</h1>

@if (_platforms == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Name</th>
            <th>TotalWallet</th>
            <th>TotalInvestment</th>
            <td>TotalProfit</td>
            <td>PercentageProfit</td>
        </tr>
        </thead>
        <tbody>
        @foreach (var platform in _platforms)
        {
            <tr @onclick="() => ToggleDetails(platform)">
                <td>@platform.Name</td>
                <td>@platform.TotalWallet</td>
                <td>@platform.TotalInvestment</td>
                <td>@platform.TotalProfit</td>
                <td>@platform.PercentageProfit</td>
            </tr>
        }
        </tbody>
    </table>

    if (_selectedPlatform is not null)
    {
        <PlatformDetails PlatformPredictions="@_predictions" Platform="@_selectedPlatform"></PlatformDetails>
    }
}

@code {
    private PlatformResponse[]? _platforms;
    private PlatformResponse? _selectedPlatform;
    private PlatformPredictionResponse[]? _predictions;

    protected override async Task OnInitializedAsync()
    {
        _platforms = await Http.GetFromJsonAsync<PlatformResponse[]>("api/Platform");
    }

    private async Task ToggleDetails(PlatformResponse platform)
    {
        var years = new[] { 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 };

        var query = string.Join("&", years.Select(year => $"years={year}"));
        _predictions = await Http.GetFromJsonAsync<PlatformPredictionResponse[]>($"api/Platform/{platform.Id}?{query}");

        _selectedPlatform = platform;
    }

}